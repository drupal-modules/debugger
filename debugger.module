<?php

/**
 * @file
 *   Drupal debugger analysing the performance issues on the website
 *
 * @version
 *   $Id$
 *
 * @developers
 *   Rafal Wieczorek <kenorb@gmail.com>
 */

require_once 'debugger.api.inc'; // load API functions
declare(ticks = 1);

define('D_MIN_TIMER', 0);
define('D_SAVE_COUNTER', 100);

/**
 * Implementation of hook_boot().
 * 
 */
function debugger_boot() {
  if (debugger_enabled()) { // to enable it, go to: admin/settings/debugger
    register_shutdown_function('debugger_shutdown'); // hook_exit or shutdown better?
    debugger_check_curr_path();
    debugger_api_clear_data();
    debugger_api_db_register_request(); // register error handler before Drupal does
    if (variable_get('debugger_enable_error_handler', TRUE)) {
      variable_set('dev_query', 1); // Enable query logging
    }
    if (variable_get('debugger_enable_error_handler', TRUE)) {
      set_error_handler('debugger_api_drupal_error_handler');
    }
    register_tick_function('debugger_tick'); // ACTIVATE debugger; if crashing, see: http://php.net/register_tick_function
  }
}

/**
 * Implementation of hook_init().
 */
function debugger_init() {
  if (debugger_enabled()) { // to enable it, go to: admin/settings/debugger
    if (variable_get('debugger_enable_error_handler', TRUE)) {
      set_error_handler('debugger_api_drupal_error_handler'); // register error handler again
    }
  }
/* Manually install again
    module_load_include('install', 'debugger');
    debugger_install();
*/
}

/**
 * Implementation of hook_menu().
 */
function debugger_menu() {
  $items['admin/settings/debugger'] = array(
    'title' => 'Debugger',
    'description' => t('Manage Drupal debugger'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('debugger_admin_form'),
    'access arguments' => array('administer debugger'),
    'file' => 'debugger.admin.inc',
  );
  return $items;
}

/**
 * Implementation of hook_perm().
 */
function debugger_perm() {
  return array('administer debugger');
}

/**
 * Implementation of hook_views_api().
 */
function debugger_views_api() {
  return array(
    'api' => 2,
    'path' => drupal_get_path('module', 'debugger') .'/views/includes',
  );
}

/**
 * Implementation of hook_exit().
 */
function debugger_exit() {
  global $debugger_exit;
  $debugger_exit = TRUE; // mark the exit correctly
}

/** 
 * Implementation of register_shutdown_function PHP callback
 *
 */ 
function debugger_shutdown() {
  global $debugger_exit;
  if (!$debugger_exit) { // If hook_exit wasn't executed, check if we are out of memory?
    $ini_size = ini_get("memory_limit");
    $curr_size = memory_get_usage();
    /* convert format size to bytes */
    switch (substr($ini_size, -1)) {
        case 'M': case 'm': (int)$ini_size *= 1048576; break;
        case 'K': case 'k': (int)$ini_size *= 1024; break;
        case 'G': case 'g': (int)$ini_size *= 1073741824; break;
    }
    
    if ($curr_size+1024*1024 > $ini_size) { // FIXME: FIX for 1G and more
      print "Fatal Error: Please increase your PHP memory limit in your php.ini! Disabling...<br>\n";
      variable_set('debugger_enable', FALSE);
      print "After that please activate Drupal debugger from settings again!<br>\n";
    }
  }
  if (debugger_enabled()) {
    if (variable_get('debugger_enable_error_handler', TRUE)) {
      variable_set('dev_query', 0);
    }
    debugger_check_curr_path(); // Fix the Apache bug when current directory is changed on shutdown
    // module_load_include('inc', 'debugger'); // include additional functions
    // debugger_savetrace(); // save backtrace into db
    unregister_tick_function('debugger_tick');
    global $queries;
    $num_sql = count($queries);
    debugger_api_db_finish_request();
  }
}

/** 
 * Helper function to check if debugger should be enabled on the current page
 */
function debugger_enabled() {
  $path = explode('/', $_GET['q']);
  $res = variable_get('debugger_enable', FALSE) && (!($path[0] == 'admin') || variable_get('debugger_enable_admin', FALSE));
  return $res;
}

/**
 * Check for Drupal root changes and fix it
 * Note: Working directory of the script can be changed on registered shutdown function under some web servers, e.g. Apache.
 */
function debugger_check_curr_path() {
  global $debugger_root_path;
  if (!$debugger_root_path) {
    $debugger_root_path = getcwd(); // Save current Drupal path, in case if we lose it
  } else {
    // Note: Working directory of the script can be changed on shutdown under some web servers, e.g. Apache.
    $debugger_root_path <> getcwd() ? chdir($debugger_root_path) : NULL; // change it back if change has been detected
  }
}

/** 
 * Implementation of register_tick_function PHP callback
 *
 * Note: register_tick_function() should not be used with threaded web server modules with PHP 5.2 or lower.
 * Note: microtime() - PHP 5.0.0  The get_as_float parameter was added.
 * Note: memory_get_peak_usage() - PHP 5.2.1  Compiling with --enable-memory-limit is no longer required for this function to exist. , PHP 5.2.0  real_usage was added.
 */ 
function debugger_tick($ticks = FALSE) {
  static $tick_counter = 0;
  global $last_timer, $last_memory; // $debugger_trace
  /* CALCULATE RESOURCES FROM THE LAST TIME */
  $curr_timer = microtime(TRUE);
  $curr_memory = function_exists('memory_get_peak_usage') ? memory_get_peak_usage() : memory_get_usage();
  $time = (float)$curr_timer-$last_timer;
  $memory = (float)$curr_memory-$last_memory;
  if ($time > (float)D_MIN_TIMER) {
    debugger_api_register_backtrace(debug_backtrace(TRUE), $time, $memory, $tick_counter, 2);
    $last_timer = $curr_timer;
    $last_memory = $curr_memory;
  }
  if ($ticks) {
    return array($tick_counter);
  }
  $tick_counter++; 
}


